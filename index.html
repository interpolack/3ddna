<html>
<script src='js/three.min.js'></script>
<script src='js/jquery.js'></script>
<script src='js/d3.js'></script>
<script src='js/CanvasRenderer.js'></script>
<script src='js/Projector.js'></script>
<style>
html, body {
  margin: 0;
  padding: 0;
  font-family: 'Helvetica Neue';
  color: #ffffff;
  text-transform: uppercase;
  font-size: 10px;
}
#controls {
  padding: 10px;
  background: none;
  position: absolute;
}
#controls .border {
  border: 2px solid #fff;
  border-radius: 3px;
  width: 10px;
  height: 10px;
  margin: 2px;
  padding: 0;
  float: left;
  cursor: pointer;
}
#gene_search {
  border-radius: 5px;
  background: none;
  border: 1px solid #fff;
  color: #fff;
  margin-top: 3px;
  padding: 3px;
}
#gene_track {
  position: relative;
  border-radius: 5px;
  border: 1px solid #fff;
  width: 50px;
  height: 200px;
  cursor: pointer;
}
</style>
<body>
  <div id='controls'>
    <form id='resolution'>
      resolution<br>
      <input id='1Mb' type="radio" name="resolution" value="1Mb" checked> 1Mb
      <input id='40kb' type="radio" name="resolution" value="40kb"> 40kb
    </form>
    <form id='coloration'>
      coloration<br>
      <input id='chromosomal' type="radio" name="coloration" value="chromosomal" checked> chromosomal<br>
      <input id='lamina' type="radio" name="coloration" value="lamina"> lamina association<br>
      <input id='spectral' type="radio" name="coloration" value="spectral"> spectral
    </form>
    toggle chromosomes<br>
    <button id='hide_all'>hide all</button>
    <button id='show_all'>show all</button>
    <form id='chromosomes'>
    </form>
    <br style='float: clear'>
    <br>
    <br>
    <br>
    gene search<br>
    <input id='gene_search' type='text'><br>
    <br style='float: clear'>
    gene track<br>
    <div id='gene_track'></div>
  </div>
  <div id='3d'></div>
</body>
<script type='x-shader/x-vertex' id='vertexShader'>

varying vec2 vUv;
varying float noise;
attribute float alpha;
varying float vAlpha;
varying vec3 vColor;

void main() {

    vAlpha = alpha;
    vUv = uv;
    vColor = color;
    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

}
</script>

<script type="x-shader/x-fragment" id="fragmentShader">
varying vec2 vUv;
varying float noise;
varying float vAlpha;
varying vec3 vColor;
uniform vec3 colorsa;

void main() {

    gl_FragColor = vec4( vColor, vAlpha );

}
</script>
<script>

var rainbow = d3.scale.category20()
var coloration = 'chromosomal'
var tubeMesh
var tubes = {}
var segments
var arrays
var bufferGeometry = {}
var segments1Mb = [
  [4997, 5158],
  [4938, 4996],
  [4850, 4937],
  [4757, 4849],
  [4661, 4756],
  [4560, 4660],
  [4437, 4559],
  [4319, 4436],
  [4200, 4318],
  [4081, 4199],
  [3954, 4080],
  [3832, 3953],
  [3704, 3831],
  [3560, 3703],
  [3413, 3559],
  [3263, 3412],
  [3110, 3262],
  [2953, 3109],
  [2774, 2952],
  [2580, 2773],
  [2418, 2579],
  [2359, 2417],
  [2271, 2358],
  [2178, 2270],
  [2082, 2177],
  [1981, 2081],
  [1858, 1980],
  [1740, 1857],
  [1621, 1739],
  [1502, 1620],
  [1375, 1501],
  [1253, 1374],
  [1125, 1252],
  [981, 1124],
  [834, 980],
  [684, 833],
  [531, 683],
  [374, 530],
  [195, 373],
  [1, 194]
]

var segments40kb = [
  [59419, 63232],
  [57965, 59418],
  [55774, 57964],
  [53492, 55773],
  [51117, 53491],
  [48604, 51116],
  [45664, 48603],
  [42755, 45663],
  [39864, 42754],
  [36894, 39863],
  [33724, 36893],
  [30698, 33723],
  [27581, 30697],
  [24170, 27580],
  [20520, 24169],
  [16862, 20519],
  [13119, 16861],
  [9210, 13118],
  [4794, 9209],
  [1, 4793]
]


function loadPDB(resolution) {
  $.get('data/Model_' + resolution + '.pdb', function(data) {
    var data = data.split('\n')
    for (var i = 0; i < data.length; i++) {
      data[i] = {'x': parseFloat(data[i].substring(31,37)), 'y': parseFloat(data[i].substring(38,45)), 'z': parseFloat(data[i].substring(46,53)), 'lamina': data[i].substring(61,64) == '1.0'}
    }
    showPDB(data, resolution)
  })
}

$('#1Mb').click(function(){ loadPDB('1Mb') })
$('#40kb').click(function(){ loadPDB('40kb')})
$('#hide_all').click(toggleAllChromosomes(false))
$('#show_all').click(toggleAllChromosomes(true))
$('#gene_search').keyup(function(e){
  e.preventDefault()
  var value = $(this).val()
  if (value.length == 0) showAllGenes()
  else showGenes(parseInt(value))
})
$('#gene_track').on('mousemove', function(e){
  var index = e.pageY - $(this).offset().top
  showGenes(index)
})
$('#coloration input').click(function(){
  coloration = $(this).val()
  colorGenes()
})


init()
loadPDB('1Mb')

function showPDB(data, resolution) {

  $('#chromosomes').empty()
  scene.remove(tubeMesh)

  segments = resolution == '1Mb' ? segments1Mb : segments40kb

  var array = []
  var attributes = []
  for (var i = 0; i < data.length; i++) {
    array.push(new THREE.Vector3((data[i].x - 100) * 100, (data[i].y - 100) * 100, (data[i].z - 100) * 100))
    attributes.push({
      'lamina': data[i].lamina
    })
  }

  arrays = []
  for (var i = 0; i < segments.length; i++) {
    arrays.push({
      'position': array.slice(segments[i][0] - 1, segments[i][1] - 1),
      'attributes': attributes.slice(segments[i][0] - 1, segments[i][1] - 1),
    })
    if (resolution == '40kb') arrays.push({
      'position': array.slice(segments[i][0] - 1 + 63232, segments[i][1] - 1 + 63232),
      'attributes': attributes.slice(segments[i][0] - 1 + 63232, segments[i][1] - 1 + 63232),
    })
  }

  tubeMesh = new THREE.Object3D()
  for (var i = 0; i < arrays.length; i++) {
    var curve = new THREE.CatmullRomCurve3(arrays[i].position)
    var geometry = new THREE.TubeGeometry(
        curve,  //path
        (segments[i % segments.length][1] - segments[i % segments.length][0]) * 5,    //segments
        4,     //radius
        resolution == '1Mb' ? 5 : 2,     //radiusSegments
        false  //closed
    )
    bufferGeometry[i] = new THREE.BufferGeometry().fromGeometry(geometry)
    var alphas = new Float32Array(bufferGeometry[i].attributes.position.count)
    var colors = new Float32Array(bufferGeometry[i].attributes.position.count * 3)
    var color = d3.rgb(rainbow(i))
    for (var v = 0; v < bufferGeometry[i].attributes.position.count; v++) {
      alphas[v] = 1
      colors[(v * 3)] = color.r / 255
      colors[(v * 3) + 1] = color.g / 255
      colors[(v * 3) + 2] = color.b / 255
    }
    bufferGeometry[i].attributes.alpha = new THREE.BufferAttribute(alphas, 1)
    bufferGeometry[i].attributes.color = new THREE.BufferAttribute(colors, 3)
    material = new THREE.ShaderMaterial({
      vertexShader: document.getElementById('vertexShader').textContent,
      fragmentShader: document.getElementById('fragmentShader').textContent,
      vertexColors: THREE.VertexColors,
      transparent: true,
      depthWrite: false,
    })
    tubes[i] = new THREE.Mesh(bufferGeometry[i], material)
    tubeMesh.add(tubes[i])
    $('#chromosomes').append("<div id='chromosome" + i + "' class='border' style='border-color: " + rainbow(i) + "; background-color:" + rainbow(i) + "'></div>")
    $('#chromosome' + i).click(toggleChromosome(i))
    if (i % 7 == 6) $('#chromosomes').append('<br>')
  }
  scene.add(tubeMesh)

  camera.position.z = resolution == '1Mb' ? 3000 : 10000

}

function toggleChromosome(i) {
  return function() {
    tubes[i].visible = !tubes[i].visible
    $('#chromosome' + i).css({ backgroundColor: tubes[i].visible ? rainbow(i) : '#000000' })
  }
}

function toggleAllChromosomes(on) {
  return function() {
    for (var i = 0; i < arrays.length; i++) {
      tubes[i].visible = on
      $('#chromosome' + i).css({ backgroundColor: on ? rainbow(i) : '#000000' })
    }
  }
}

function showAllGenes() {
  for (var i = 0; i < arrays.length; i++) {
    var alphas = new Float32Array(bufferGeometry[i].attributes.position.count)
    for (var a = 0; a < bufferGeometry[i].attributes.position.count; a++) alphas[a] = 1
    bufferGeometry[i].attributes.alpha = new THREE.BufferAttribute(alphas, 1)
  }
}

function showGenes(bin) {
  for (var i = 0; i < arrays.length; i++) {
    var alphas = new Float32Array(bufferGeometry[i].attributes.position.count)
    for (var a = 0; a < bufferGeometry[i].attributes.position.count; a++) {
      if (a > bin * 30 * 5 && a < (bin + 1) * 30 * 5) alphas[a] = 1
      else alphas[a] = 0.1
    }
    bufferGeometry[i].attributes.alpha = new THREE.BufferAttribute(alphas, 1)
  }
}

function colorGenes() {
  for (var i = 0; i < arrays.length; i++) {
    var total = bufferGeometry[i].attributes.position.count
    var colors = new Float32Array(total * 3)
    var alphas = new Float32Array(total)
    if (coloration == 'chromosomal') {
      var color = d3.rgb(rainbow(i))
      for (var v = 0; v < total; v++) {
        colors[(v * 3)] = color.r / 255
        colors[(v * 3) + 1] = color.g / 255
        colors[(v * 3) + 2] = color.b / 255
        alphas[v] = 1
      }
    } else if (coloration == 'lamina') {
      for (var bin = 0; bin < arrays[i].attributes.length; bin++) {
        var lamina = arrays[i].attributes[bin].lamina
        for (var v = bin * 30 * 5; v < (bin + 1) * 30 * 5; v++) {
          colors[(v * 3)] = lamina ? 0 : 1
          colors[(v * 3) + 1] = lamina ? 1 : 0
          colors[(v * 3) + 2] = lamina ? 0.5 : 0
          alphas[v] = lamina ? 1 : 0.5
        }
      }
    } else if (coloration == 'spectral') {
      for (var v = 0; v < total; v++) {
        colors[(v * 3)] = v / total
        colors[(v * 3) + 1] = (total - v) / total
        colors[(v * 3) + 2] = (total - v) / total
        alphas[v] = 1
      }
    }
    bufferGeometry[i].attributes.color = new THREE.BufferAttribute(colors, 3)
    bufferGeometry[i].attributes.alpha = new THREE.BufferAttribute(alphas, 1)
  }
}

function init() {

  scene = new THREE.Scene()
  camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 20000)
  camera.position.z = 3000
  scene.add(camera)

  // var light = new THREE.PointLight(0xffffff, 5, 2000)
  // light.position.set(0,0,2000)
  // scene.add(light)

  renderer = new THREE.WebGLRenderer()
  renderer.setSize(window.innerWidth, window.innerHeight)
  document.body.appendChild(renderer.domElement)
  animate()

}

function animate() {
  requestAnimationFrame(animate)
  render()
}

function render() {
  if (tubeMesh != null) {
    tubeMesh.rotation.x += 0.01
    tubeMesh.rotation.y += 0.01
    tubeMesh.rotation.z += 0.01
  }
  renderer.render(scene, camera)
}

</script>
</html>
